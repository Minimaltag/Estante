<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Estante</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --accent:#3b82f6;
    --shadow: 0 4px 12px rgba(31,41,55,0.08);
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);min-height:100vh;color:#0f172a;transition: background 0.2s}
  header{display:flex;align-items:center;justify-content:space-between;padding:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),#7c3aed);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;box-shadow:var(--shadow);}
  h1{margin:0;font-size:18px}
  p.sub{margin:0;color:var(--muted);font-size:12px}main{padding:12px}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .btn{background:var(--accent);color:white;padding:8px 14px;border-radius:8px;border:0;cursor:pointer;font-size:14px;transition:all 0.2s}
  .btn:hover{background:#2563eb;transform:translateY(-1px)}
  .search{flex:1;display:flex;align-items:center;background:#fff;padding:6px 10px;border-radius:8px;border:1px solid #eef2ff}
  .search input{flex:1;border:0;outline:none;padding:6px;font-size:13px}

  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:480px){.grid{grid-template-columns:repeat(2,1fr)}}

  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;gap:8px;min-height:140px;position:relative;transition:transform 0.2s}
  .card:hover{transform:translateY(-2px)}
  .thumb{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:500;font-size:13px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%}

  .card .actions{display:flex;gap:6px;margin-top:auto}
  .icon-btn{background:#f3f4f6;border:0;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
  .icon-btn:hover{background:#e2e8f0}
  .icon-btn.danger{background:#fee2e2;color:#b91c1c}
  .icon-btn.danger:hover{background:#fca5a5}

  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:10}
  .modal{background:var(--card);border-radius:10px;padding:16px;max-width:400px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.25)}
  .modal h2{margin:0 0 12px;font-size:16px}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
  .field input{padding:8px;border-radius:6px;border:1px solid #e6eefc;font-size:13px}
  .row{display:flex;gap:6px;justify-content:flex-end}

  footer{height:12px}
  .empty{color:var(--muted);text-align:center;padding:20px;border:2px dashed #e6eefc;border-radius:8px;font-size:13px}
</style>
</head>
<link rel="manifest" href="manifest.json">
<body>

<header>
  <div class="brand">
    <div class="logo">B</div>
    <div>
      <h1>Minha Biblioteca</h1>
      <p class="sub">Organize seus links em formato de ícones</p>
    </div>
  </div>
  <div>
    <button id="addBtn" class="btn">+ Link</button>
  </div>
</header>

<main>
  <div class="controls">
    <div class="search">
      <input id="search" placeholder="Buscar" />
    </div>
  </div>
  <div id="grid" class="grid"></div>
  <div id="emptyMessage" class="empty" style="display:none;margin-top:12px">
    Nenhum link. Clique em <strong>+ Link</strong> para começar.
  </div>
</main>

<footer></footer>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h2 id="modalTitle">Adicionar link</h2>
    <div class="field">
      <label>URL</label>
      <input id="inputUrl" placeholder="https://exemplo.com" />
    </div>
    <div class="field">
      <label>Título (opcional)</label>
      <input id="inputTitle" placeholder="Título do site" />
    </div>
    <div class="field">
      <label>Ícone personalizado (opcional)</label>
      <input id="inputIcon" placeholder="URL do ícone" />
    </div>
    <div class="row">
      <button id="cancelBtn" class="icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M6.707 6.707a1 1 0 0 1 1.414 0L12 10.586l3.879-3.879a1 1 0 1 1 1.414 1.414L13.414 12l3.879 3.879a1 1 0 0 1-1.414 1.414L12 13.414l-3.879 3.879a1 1 0 0 1-1.414-1.414L10.586 12 6.707 8.121a1 1 0 0 1 0-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      <button id="saveBtn" class="icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M20.707 6.293a1 1 0 0 1 0 1.414l-11 11a1 1 0 0 1-1.414 0l-5-5a1 1 0 0 1 1.414-1.414L9 16.586l10.293-10.293a1 1 0 0 1 1.414 0z" clip-rule="evenodd"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDd-i47C51sseWaMtZbBBdPbObjP1_kYzU",
  authDomain: "minimaltag-28769.firebaseapp.com",
  projectId: "minimaltag-28769",
  storageBucket: "minimaltag-28769.firebasestorage.app",
  messagingSenderId: "645337589970",
  appId: "1:645337589970:web:24be0fabbc3f2b30eaa50b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Elementos
const grid = document.getElementById('grid');
const modalBackdrop = document.getElementById('modalBackdrop');
const addBtn = document.getElementById('addBtn');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const inputUrl = document.getElementById('inputUrl');
const inputTitle = document.getElementById('inputTitle');
const inputIcon = document.getElementById('inputIcon');
const modalTitle = document.getElementById('modalTitle');
const emptyMessage = document.getElementById('emptyMessage');
const searchInput = document.getElementById('search');

let links = [];
let editingLink = null;

// Funções
function ensureHttp(url){return /^https?:\/\//i.test(url)?url:'https://'+url}
function fetchFavicon(url){ try{const domain=(new URL(url)).origin; return domain+'/favicon.ico';}catch(e){return ''} }
function favIconUrl(link){ return link.icon ? link.icon : fetchFavicon(link.url) || `https://www.google.com/s2/favicons?domain=${(new URL(link.url)).hostname}&sz=64`; }

// Firestore CRUD
const linksCollection = collection(db, "links");

async function fetchLinks() {
  const snapshot = await getDocs(linksCollection);
  links = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  render();
}

async function saveLink(link) {
  if(link.id){
    await updateDoc(doc(db, "links", link.id), { url: link.url, title: link.title, icon: link.icon });
  } else {
    await addDoc(linksCollection, link);
  }
  await fetchLinks();
}

async function deleteLink(id){
  await deleteDoc(doc(db, "links", id));
  await fetchLinks();
}

// Renderização
function render(filter=''){
  grid.innerHTML = '';
  const list = links.filter(l => (l.title||'').toLowerCase().includes(filter.toLowerCase()) || (l.url||'').toLowerCase().includes(filter.toLowerCase()));
  emptyMessage.style.display = list.length===0 ? 'block':'none';
  
  list.forEach(link => {
    const card = document.createElement('div'); card.className='card';
    const thumb = document.createElement('div'); thumb.className='thumb';
    const favImg = document.createElement('img');
    favImg.src = favIconUrl(link);
    favImg.onerror = ()=>{favImg.src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="48" height="48" fill="%23e5e7eb"/></svg>'};
    thumb.appendChild(favImg);

    const title = document.createElement('div'); title.className='title'; title.textContent = link.title || (new URL(link.url)).hostname;

    const actions = document.createElement('div'); actions.className='actions';

    const openBtn = document.createElement('button'); openBtn.className='icon-btn';
    openBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 4a1 1 0 0 1 1 1v6h6a1 1 0 0 1 0 2h-6v6a1 1 0 0 1-2 0v-6H5a1 1 0 0 1 0-2h6V5a1 1 0 0 1 1-1z" clip-rule="evenodd"/></svg>';
    openBtn.onclick = ()=>window.open(link.url,'_blank');

    const editBtn = document.createElement('button'); editBtn.className='icon-btn';
    editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M16.293 3.293a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-10 10a1 1 0 0 1-.39.242l-4 1a1 1 0 0 1-1.266-1.266l1-4a1 1 0 0 1 .242-.39l10-10zM15.586 5L7 13.586l-.707 2.829 2.829-.707L17.586 7H15.586v-2z" clip-rule="evenodd"/></svg>';
    editBtn.onclick = ()=>openEditModal(link);

    const delBtn = document.createElement('button'); delBtn.className='icon-btn danger';
    delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M9 4a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H4a1 1 0 0 0 0 2h1v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V6h1a1 1 0 0 0 0-2h-2a1 1 0 0 0-1-1H9zm1 3a1 1 0 0 1 1 1v8a1 1 0 0 1-2 0V8a1 1 0 0 1 1-1z" clip-rule="evenodd"/></svg>';
    delBtn.onclick = ()=>{ if(confirm('Remover este link?')) deleteLink(link.id) };

    actions.appendChild(openBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
    card.appendChild(thumb); card.appendChild(title); card.appendChild(actions);
    grid.appendChild(card);
  });
}

// Modal
function openAddModal(){ editingLink=null; modalTitle.textContent='Adicionar link'; inputUrl.value=''; inputTitle.value=''; inputIcon.value=''; showModal(); }
function openEditModal(link){ editingLink=link; modalTitle.textContent='Editar link'; inputUrl.value=link.url; inputTitle.value=link.title||''; inputIcon.value=link.icon||''; showModal(); }
function showModal(){ modalBackdrop.style.display='flex'; inputUrl.focus(); }
function closeModal(){ modalBackdrop.style.display='none'; }

// Eventos
addBtn.addEventListener('click', openAddModal);
cancelBtn.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal() });
searchInput.addEventListener('input', e=>render(e.target.value));

saveBtn.addEventListener('click', async ()=>{
  let url = inputUrl.value.trim(); if(!url) return alert('Informe a URL'); url=ensureHttp(url);
  const title = inputTitle.value.trim();
  const icon = inputIcon.value.trim();
  const link = editingLink ? { id: editingLink.id, url, title, icon } : { url, title, icon };
  await saveLink(link);
  closeModal();
});

// Inicialização
fetchLinks();
</script>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("Service Worker registrado"))
      .catch(err => console.error("SW erro:", err));
  }
</script>
</body>
</html>
