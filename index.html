<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minha Biblioteca na Nuvem</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --accent:#3b82f6;
    --shadow: 0 4px 12px rgba(31,41,55,0.08);
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);min-height:100vh;color:#0f172a}
  header{display:flex;align-items:center;justify-content:space-between;padding:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),#7c3aed);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--shadow)}
  h1{margin:0;font-size:18px}
  p.sub{margin:0;color:var(--muted);font-size:12px}main{padding:12px}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-size:14px}
  .search{flex:1;display:flex;align-items:center;background:#fff;padding:6px 10px;border-radius:8px;border:1px solid #eef2ff}
  .search input{flex:1;border:0;outline:none;padding:4px 6px;font-size:13px}

  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:480px){.grid{grid-template-columns:repeat(2,1fr)}}

  .card{background:var(--card);border-radius:10px;padding:8px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;gap:6px;min-height:120px;position:relative}
  .thumb{width:48px;height:48px;border-radius:8px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:500;font-size:13px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%}

  .card .actions{display:flex;gap:4px;margin-top:auto}
  .icon-btn{background:transparent;border:1px solid #eef2ff;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:12px}
  .icon-btn.danger{border-color:#fed7d7;color:#b91c1c}

  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px}
  .modal{background:var(--card);border-radius:10px;padding:16px;max-width:400px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.25)}
  .modal h2{margin:0 0 10px;font-size:16px}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
  .field input{padding:8px;border-radius:6px;border:1px solid #e6eefc;font-size:13px}
  .row{display:flex;gap:6px}

  footer{padding:12px;color:var(--muted);font-size:11px;text-align:center}
  .empty{color:var(--muted);text-align:center;padding:20px;border:2px dashed #e6eefc;border-radius:8px;font-size:13px}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">B</div>
    <div>
      <h1>Minha Biblioteca</h1>
      <p class="sub">Organize seus links em formato de ícones</p>
    </div>
  </div>
  <div>
    <button id="addBtn" class="btn">+ Link</button>
  </div>
</header>

<main>
  <div class="controls">
    <div class="search">
      <input id="search" placeholder="Buscar" />
    </div>
  </div>
  <div id="grid" class="grid"></div>
  <div id="emptyMessage" class="empty" style="display:none;margin-top:12px">
    Nenhum link. Clique em <strong>+ Link</strong> para começar.
  </div>
</main>

<footer>
  Favicons são carregados automaticamente ou via Google S2 como fallback.
</footer>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h2 id="modalTitle">Adicionar link</h2>
    <div class="field">
      <label>URL</label>
      <input id="inputUrl" placeholder="https://exemplo.com" />
    </div>
    <div class="field">
      <label>Título (opcional)</label>
      <input id="inputTitle" placeholder="Título do site" />
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelBtn" class="icon-btn">Cancelar</button>
      <button id="saveBtn" class="btn">Salvar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDd-i47C51sseWaMtZbBBdPbObjP1_kYzU",
  authDomain: "minimaltag-28769.firebaseapp.com",
  projectId: "minimaltag-28769",
  storageBucket: "minimaltag-28769.firebasestorage.app",
  messagingSenderId: "645337589970",
  appId: "1:645337589970:web:24be0fabbc3f2b30eaa50b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Elementos
const grid = document.getElementById('grid');
const modalBackdrop = document.getElementById('modalBackdrop');
const addBtn = document.getElementById('addBtn');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const inputUrl = document.getElementById('inputUrl');
const inputTitle = document.getElementById('inputTitle');
const modalTitle = document.getElementById('modalTitle');
const emptyMessage = document.getElementById('emptyMessage');
const searchInput = document.getElementById('search');

let links = [];
let editingLink = null;

// Funções
function ensureHttp(url){return /^https?:\/\//i.test(url)?url:'https://'+url}
function fetchFavicon(url){
  try{
    const domain = (new URL(url)).origin;
    return domain + '/favicon.ico';
  } catch(e){ return '' }
}
function favIconUrl(url){
  const favicon = fetchFavicon(url);
  return favicon ? favicon : `https://www.google.com/s2/favicons?domain=${(new URL(url)).hostname}&sz=64`;
}

// Firestore CRUD
const linksCollection = collection(db, "links");

async function fetchLinks() {
  const snapshot = await getDocs(linksCollection);
  links = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  render();
}

async function saveLink(link) {
  if(link.id){
    await updateDoc(doc(db, "links", link.id), { url: link.url, title: link.title });
  } else {
    await addDoc(linksCollection, link);
  }
  await fetchLinks();
}

async function deleteLink(id){
  await deleteDoc(doc(db, "links", id));
  await fetchLinks();
}

// Renderização
function render(filter=''){
  grid.innerHTML = '';
  const list = links.filter(l => (l.title||'').toLowerCase().includes(filter.toLowerCase()) || (l.url||'').toLowerCase().includes(filter.toLowerCase()));
  emptyMessage.style.display = list.length===0 ? 'block':'none';
  
  list.forEach(link => {
    const card = document.createElement('div'); card.className='card';
    const thumb = document.createElement('div'); thumb.className='thumb';
    const favImg = document.createElement('img');
    favImg.src = favIconUrl(link.url);
    favImg.onerror = ()=>{favImg.src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="48" height="48" fill="%23e5e7eb"/></svg>'};
    thumb.appendChild(favImg);

    const title = document.createElement('div'); title.className='title'; title.textContent = link.title || (new URL(link.url)).hostname;

    const actions = document.createElement('div'); actions.className='actions';
    const openBtn = document.createElement('button'); openBtn.className='icon-btn'; openBtn.innerHTML='Abrir'; openBtn.onclick = ()=>window.open(link.url,'_blank');
    const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML='Editar'; editBtn.onclick = ()=>openEditModal(link);
    const delBtn = document.createElement('button'); delBtn.className='icon-btn danger'; delBtn.innerHTML='X'; delBtn.onclick = ()=>{ if(confirm('Remover este link?')) deleteLink(link.id) };

    actions.appendChild(openBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
    card.appendChild(thumb); card.appendChild(title); card.appendChild(actions);
    grid.appendChild(card);
  });
}

// Modal
function openAddModal(){ editingLink=null; modalTitle.textContent='Adicionar link'; inputUrl.value=''; inputTitle.value=''; showModal(); }
function openEditModal(link){ editingLink=link; modalTitle.textContent='Editar link'; inputUrl.value=link.url; inputTitle.value=link.title||''; showModal(); }
function showModal(){ modalBackdrop.style.display='flex'; inputUrl.focus(); }
function closeModal(){ modalBackdrop.style.display='none'; }

// Eventos
addBtn.addEventListener('click', openAddModal);
cancelBtn.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal() });
searchInput.addEventListener('input', e=>render(e.target.value));

saveBtn.addEventListener('click', async ()=>{
  let url = inputUrl.value.trim(); if(!url) return alert('Informe a URL'); url=ensureHttp(url);
  const title = inputTitle.value.trim();
  const link = editingLink ? { id: editingLink.id, url, title } : { url, title };
  await saveLink(link);
  closeModal();
});

// Inicialização
fetchLinks();
</script>

</body>
</html>